databaseChangeLog:
  - changeSet:
      id: 005-create-knowledge-bases-table
      author: ai-assistant
      changes:
        - createTable:
            tableName: knowledge_bases
            remarks: "知识库表"
            columns:
              - column:
                  name: id
                  type: VARCHAR(36)
                  remarks: "知识库ID"
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: name
                  type: VARCHAR(255)
                  remarks: "知识库名称"
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
                  remarks: "知识库描述"
              - column:
                  name: embedding_model
                  type: VARCHAR(100)
                  remarks: "嵌入模型"
                  defaultValue: "text-embedding-ada-002"
              - column:
                  name: chunk_size
                  type: INT
                  remarks: "分块大小"
                  defaultValueNumeric: 500
              - column:
                  name: chunk_overlap
                  type: INT
                  remarks: "分块重叠"
                  defaultValueNumeric: 50
              - column:
                  name: created_at
                  type: BIGINT
                  remarks: "创建时间戳"
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: BIGINT
                  remarks: "更新时间戳"
                  constraints:
                    nullable: false
        - createIndex:
            tableName: knowledge_bases
            indexName: idx_knowledge_bases_created_at
            columns:
              - column:
                  name: created_at

  - changeSet:
      id: 005-create-documents-table
      author: ai-assistant
      changes:
        - createTable:
            tableName: documents
            remarks: "文档表"
            columns:
              - column:
                  name: id
                  type: VARCHAR(36)
                  remarks: "文档ID"
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: knowledge_base_id
                  type: VARCHAR(36)
                  remarks: "所属知识库ID"
                  constraints:
                    nullable: false
              - column:
                  name: file_name
                  type: VARCHAR(255)
                  remarks: "文件名"
                  constraints:
                    nullable: false
              - column:
                  name: file_type
                  type: VARCHAR(50)
                  remarks: "文件类型"
                  constraints:
                    nullable: false
              - column:
                  name: file_size
                  type: BIGINT
                  remarks: "文件大小(字节)"
                  constraints:
                    nullable: false
              - column:
                  name: file_path
                  type: VARCHAR(500)
                  remarks: "文件存储路径"
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(20)
                  remarks: "处理状态(PENDING/PROCESSING/COMPLETED/FAILED)"
                  constraints:
                    nullable: false
              - column:
                  name: error_message
                  type: TEXT
                  remarks: "错误信息"
              - column:
                  name: chunk_count
                  type: INT
                  remarks: "文档块数量"
                  defaultValueNumeric: 0
              - column:
                  name: tags
                  type: JSON
                  remarks: "标签(JSON数组)"
              - column:
                  name: category
                  type: VARCHAR(100)
                  remarks: "分类"
              - column:
                  name: created_at
                  type: BIGINT
                  remarks: "创建时间戳"
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: BIGINT
                  remarks: "更新时间戳"
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: documents
            baseColumnNames: knowledge_base_id
            referencedTableName: knowledge_bases
            referencedColumnNames: id
            constraintName: fk_documents_knowledge_base
            onDelete: CASCADE
        - createIndex:
            tableName: documents
            indexName: idx_documents_kb_id
            columns:
              - column:
                  name: knowledge_base_id
        - createIndex:
            tableName: documents
            indexName: idx_documents_status
            columns:
              - column:
                  name: status

  - changeSet:
      id: 005-create-document-chunks-table
      author: ai-assistant
      changes:
        - createTable:
            tableName: document_chunks
            remarks: "文档块表"
            columns:
              - column:
                  name: id
                  type: VARCHAR(36)
                  remarks: "文档块ID"
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: document_id
                  type: VARCHAR(36)
                  remarks: "所属文档ID"
                  constraints:
                    nullable: false
              - column:
                  name: content
                  type: TEXT
                  remarks: "文档块内容"
                  constraints:
                    nullable: false
              - column:
                  name: chunk_index
                  type: INT
                  remarks: "块索引"
                  constraints:
                    nullable: false
              - column:
                  name: vector_id
                  type: VARCHAR(100)
                  remarks: "向量存储ID"
                  constraints:
                    nullable: false
              - column:
                  name: metadata
                  type: JSON
                  remarks: "元数据(JSON格式)"
              - column:
                  name: created_at
                  type: BIGINT
                  remarks: "创建时间戳"
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: document_chunks
            baseColumnNames: document_id
            referencedTableName: documents
            referencedColumnNames: id
            constraintName: fk_chunks_document
            onDelete: CASCADE
        - createIndex:
            tableName: document_chunks
            indexName: idx_chunks_document_id
            columns:
              - column:
                  name: document_id
        - createIndex:
            tableName: document_chunks
            indexName: idx_chunks_vector_id
            columns:
              - column:
                  name: vector_id

  - changeSet:
      id: 005-create-session-knowledge-bases-table
      author: ai-assistant
      changes:
        - createTable:
            tableName: session_knowledge_bases
            remarks: "会话知识库关联表"
            columns:
              - column:
                  name: id
                  type: VARCHAR(36)
                  remarks: "关联ID"
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: session_id
                  type: VARCHAR(36)
                  remarks: "会话ID"
                  constraints:
                    nullable: false
              - column:
                  name: knowledge_base_id
                  type: VARCHAR(36)
                  remarks: "知识库ID"
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: BIGINT
                  remarks: "创建时间戳"
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: session_knowledge_bases
            baseColumnNames: session_id
            referencedTableName: sessions
            referencedColumnNames: id
            constraintName: fk_session_kb_session
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: session_knowledge_bases
            baseColumnNames: knowledge_base_id
            referencedTableName: knowledge_bases
            referencedColumnNames: id
            constraintName: fk_session_kb_knowledge_base
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: session_knowledge_bases
            columnNames: session_id, knowledge_base_id
            constraintName: uk_session_kb
        - createIndex:
            tableName: session_knowledge_bases
            indexName: idx_session_kb_session_id
            columns:
              - column:
                  name: session_id
